{{ define "plan" }}
<div class="plan-html">
    <div id="plan-table" class="el-table el-table--fit el-table--enable-row-hover el-table--enable-row-transition"
        style="width: 100%;">
        <div class="el-table__header-wrapper">
            <table cellspacing="0" cellpadding="0" border="0" class="el-table__header">
                <colgroup>
                    <col name="el-table_1_column_1" width="80">
                    <col name="el-table_1_column_2" width="200">
                    <col name="el-table_1_column_3" width="500">
                    <col name="el-table_1_column_4" width="80">
                    <col name="el-table_1_column_8" width="180">
                    <col name="el-table_1_column_9" width="200">
                    <col name="gutter" width="0">
                </colgroup>
                <thead class="has-gutter">
                    <tr class="">
                        <th colspan="1" rowspan="1" class="el-table_1_column_1     is-leaf el-table__cell">
                            <div class="cell">ID</div>
                        </th>
                        <th colspan="1" rowspan="1" class="el-table_1_column_2     is-leaf el-table__cell">
                            <div class="cell">名称</div>
                        </th>
                        <th colspan="1" rowspan="1" class="el-table_1_column_3     is-leaf el-table__cell">
                            <div class="cell">描述</div>
                        </th>
                        <th colspan="1" rowspan="1" class="el-table_1_column_4     is-leaf el-table__cell">
                            <div class="cell">状态</div>
                        </th>
                        <th colspan="1" rowspan="1" class="el-table_1_column_6     is-leaf el-table__cell">
                            <div class="cell">是否删除</div>
                        </th>
                        <th colspan="1" rowspan="1" class="el-table_1_column_9     is-leaf el-table__cell">
                            <div class="cell">操作</div>
                        </th>
                        <th class="el-table__cell gutter" style="width: 0px; display: none;"></th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="el-table__body-wrapper is-scrolling-none">
            <table cellspacing="0" cellpadding="0" border="0" class="el-table__body">
                <colgroup>
                    <col name="el-table_1_column_1" width="80">
                    <col name="el-table_1_column_2" width="200">
                    <col name="el-table_1_column_3" width="500">
                    <col name="el-table_1_column_4" width="80">
                    <col name="el-table_1_column_8" width="180">
                    <col name="el-table_1_column_9" width="200">
                </colgroup>
                <tbody id="plan-body"></tbody>
            </table>
            <button type="button" class="el-button el-button--primary is-circle" size="mini" onclick="addPlan()">
                <i class="el-icon-circle-plus"></i>
            </button>
        </div>
        <div class="el-table__column-resize-proxy" style="display: none;"></div>
    </div>
    <div id="plan-pagination" style="margin-top: 10px;" class="el-pagination is-background">
        <button type="button" disabled="disabled" class="btn-prev el-icon el-icon-arrow-left"></button>
        <ul class="el-pager"></ul>
        <button type="button" class="btn-next el-icon el-icon-arrow-right"></button>
    </div>
    <div id="plan-add" style="display: none;">
        <div tabindex="-1" role="dialog" aria-modal="true" aria-label="添加工作" class="el-message-box__wrapper"
            style="z-index: 2001;">
            <div class="el-message-box">
                <div class="el-message-box__header">
                    <div class="el-message-box__title">
                        <span>添加工作</span>
                    </div>
                    <button type="button" aria-label="Close" class="el-message-box__headerbtn"
                        onclick="closePlanMsg2()">
                        <i class="el-message-box__close el-icon-close"></i>
                    </button>
                </div>
                <div class="el-message-box__content">
                    <div class="el-message-box__container">
                        <div class="el-message-box__message">
                            <form class="el-form">
                                <div class="el-form-item">
                                    <label class="el-form-item__label" style="width: 80px;">任务名称</label>
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <div class="el-input">
                                            <input id="plan-input-name-add" type="text" autocomplete="off"
                                                class="el-input__inner">
                                        </div>
                                    </div>
                                </div>
                                <div class="el-form-item">
                                    <label class="el-form-item__label" style="width: 80px;">任务描述</label>
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <div class="el-input">
                                            <input id="plan-input-description-add" type="text" autocomplete="off"
                                                class="el-input__inner">
                                        </div>
                                    </div>
                                </div>
                                <div class="el-form-item">
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <button onclick="modPlanFun('add')" type="button"
                                            class="el-button el-button--primary">
                                            <span>添加</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="v-modal" tabindex="0" style="z-index: 2000;"></div>
    </div>
    <div id="plan-edit" style="display: none;">
        <div tabindex="-1" role="dialog" aria-modal="true" aria-label="更新任务" class="el-message-box__wrapper"
            style="z-index: 2001;">
            <div class="el-message-box">
                <div class="el-message-box__header">
                    <div class="el-message-box__title">
                        <span>更新工作</span>
                    </div>
                    <button type="button" aria-label="Close" class="el-message-box__headerbtn" onclick="closePlanMsg()">
                        <i class="el-message-box__close el-icon-close"></i>
                    </button>
                </div>
                <div class="el-message-box__content">
                    <div class="el-message-box__container">
                        <div class="el-message-box__message">
                            <form class="el-form">
                                <div class="el-form-item">
                                    <label class="el-form-item__label" style="width: 80px;">工作名称</label>
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <div class="el-input">
                                            <input id="plan-input-name" type="text" autocomplete="off"
                                                class="el-input__inner" value="">
                                        </div>
                                    </div>
                                </div>
                                <div class="el-form-item">
                                    <label class="el-form-item__label" style="width: 80px;">工作描述</label>
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <div class="el-input">
                                            <input id="plan-input-description" type="text" autocomplete="off"
                                                class="el-input__inner" value="">
                                        </div>
                                    </div>
                                </div>
                                <div class="el-form-item">
                                    <label class="el-form-item__label" style="width: 80px;">状态</label>
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <div id="pstatus" role="switch" class="el-switch" onclick="statusSw()">
                                            <input type="checkbox" name="" true-value="true" class="el-switch__input">
                                            <span class="el-switch__core" style="width: 40px;"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="el-form-item">
                                    <div class="el-form-item__content" style="margin-left: 80px;">
                                        <button onclick="modPlanFun('mod')" type="button"
                                            class="el-button el-button--primary">
                                            <span>更新</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="v-modal" tabindex="0" style="z-index: 2000;"></div>
    </div>
    <div id="success" role="alert" class="el-alert el-alert--success is-dark" style="display: none;">
        <div class="el-alert__content">
            <span class="el-alert__title" id="success-title">成功提示的文案</span>
            <i class="el-alert__closebtn el-icon-close"></i>
        </div>
    </div>
    <div id="error" role="alert" class="el-alert el-alert--error is-dark" style="display: none;">
        <div class="el-alert__content">
            <span id="error-title" class="el-alert__title">错误提示的文案</span>
            <i class="el-alert__closebtn el-icon-close"></i>
        </div>
    </div>
</div>
<script src="/public/js/page.js"></script>
<script>
    var planPages = 1
    var planPid = "#plan-pagination"
    function getPlanData(page_no) {
        $.ajax({
            url: "/in/api/tools/v1/plan?page_no=" + page_no,
            type: "GET",
            headers: {
                "Authorization": $.cookie("Authorization")
            },
            async: false,
            success: function (json) {
                planPages = json.pages
                var json = json.data
                var str = ""
                for (var i = 0; i < json.length; i++) {
                    var item = json[i]
                    str += "<tr class='el-table__row'><td rowspan='1' colspan='1' class='el-table_1_column_1   el-table__cell'><div class='cell'>"
                    str += item.id
                    str += "</div></td><td rowspan='1' colspan='1' class='el-table_1_column_2   el-table__cell'><div class='cell'>"
                    str += item.name
                    str += "</div></td><td rowspan='1' colspan='1' class='el-table_1_column_3   el-table__cell'><div class='cell'>"
                    str += item.description
                    str += "</div></td><td rowspan='1' colspan='1' class='el-table_1_column_4   el-table__cell'><div class='cell'>"
                    if (item.plan_status == 1) {
                        str += "<i class='el-icon-star-on' style='color: green;'></i>"
                    } else {
                        str += "<i class='el-icon-star-off' style='color: gray;'></i>"
                    }
                    str += "</div></td><td rowspan='1' colspan='1' class='el-table_1_column_6   el-table__cell'><div class='cell'>"
                    if (item.del_tag == 0) {
                        str += "<i class='el-icon-check' style='color: green;'></i>"
                    } else {
                        str += "<i class='el-icon-close' style='color: red;'></i>"
                    }
                    str += "</div></td><td rowspan='1' colspan='1' class='el-table_1_column_8   el-table__cell'><div class='cell'><button type='button' tdid='" + item.id + "' class='modify-plan el-button el-button--primary is-circle  el-icon-edit' size='mini'></button><button tdid='" + item.id + "' type='button' class='del-plan el-button el-button--danger is-circle el-icon-delete' size='mini'></button></div></td></tr>"
                }
                $("#plan-body").html(str)
            }
        })
    }
    getPlanData(1)
    setPage(planPid, planPages, 1, "+")
    $(".el-pager").click(function (e) {
        $(".el-pager>li").removeClass("active")
        $(e.target).addClass("active")
        var page_no = $(e.target).html()
        getPlanData(page_no)
        if (page_no != 1) {
            $(planPid + ">.btn-prev").attr("disabled", false)
        } else {
            $(planPid + ">.btn-prev").attr("disabled", true)
        }
        if (page_no == planPages) {
            $(planPid + ">.btn-next").attr("disabled", true)
        } else {
            $(planPid + ">.btn-next").attr("disabled", false)
        }
    })
    $(planPid + ">.btn-prev").click(function (e) {
        var page_no = $(planPid + ">.el-pager>.active").html()
        var next_page = page_no - 1
        setPage(planPid, planPages, next_page, "-")
        getPlanData(next_page)
    })
    $(planPid + ">.btn-next").click(function (e) {
        var page_no = Number($(planPid + ">.el-pager>.active").html())
        var next_page = page_no + 1
        setPage(planPid, planPages, next_page, "+")
        getPlanData(next_page)
    })
    function closeSuccess() {
        $("#success").fadeOut()
    }
    function statusSw() {
        if ($("#pstatus").hasClass("is-checked")) {
            $("#pstatus").removeClass("is-checked")
        } else {
            $("#pstatus").addClass("is-checked")
        }
    }
    function closePlanMsg() {
        $("#plan-edit").fadeOut()
    }
    function addPlan() {
        $("#plan-add").fadeIn()
    }
    function closePlanMsg2() {
        $("#plan-add").fadeOut()
    }
    $("#plan-body").on("click", ".modify-plan", function (e) {
        var tr = $(e.target).parent().parent().parent()
        var tmp = $($(tr).children()[3]).html()
        if (tmp.indexOf("gray") >= 0) {
            var tEnabled = 0
        } else {
            var tEnabled = 1
        }
        var tId = Number($($($(tr).children()[0]).children()[0]).html())
        var tName = $($($(tr).children()[1]).children()[0]).html()
        var tDescription = $($($(tr).children()[2]).children()[0]).html()
        console.log(tId, tName, tDescription, tEnabled)
        $("#plan-input-name").val(tName)
        $("#plan-input-description").val(tDescription)
        if (tEnabled == 1) {
            $("#pstatus").addClass("is-checked")
        } else {
            $("#pstatus").removeClass("is-checked")
        }
        $("#pstatus").attr("tdid", tId)
        $("#plan-edit").fadeIn()
    })
    $("#plan-body").on("click", ".del-plan", function (e) {
        var planId = $(e.target).attr("tdid")
        var item = {
            "id": Number(planId)
        }
        item["cud"] = "delete"
        $.ajax({
            type: "POST",
            url: "/in/api/tools/v1/plan",
            dataType: "json",
            headers: {
                "Authorization": $.cookie("Authorization")
            },
            data: JSON.stringify(item),
            contentType: "application/json;charset=utf-8",
            success: function (json) {
                if (json["msg"] == "删除数据成功") {
                    $("#success").fadeIn()
                    $("#success-title").html(json["msg"])
                    setTimeout(function () {
                        $("#success").fadeOut()
                        location.reload(0)
                    }, 1000)
                } else {
                    $("#error").fadeIn()
                    $("#error-title").html("删除数据失败")
                    setTimeout(function () {
                        $("#error").fadeOut()
                    }, 1000)
                }
            }
        })
    })
    function modPlanFun(op) {
        if (op == "mod") {
            if ($("#pstatus").hasClass("is-checked")) {
                ch = 1
            } else {
                ch = 0
            }
            var item = {
                "id": Number($("#pstatus").attr("tdid")),
                "cud": "put",
                "name": $("#plan-input-name").val(),
                "description": $("#plan-input-description").val(),
                "plan_status": ch
            }
            $.ajax({
                type: "POST",
                url: "/in/api/tools/v1/plan",
                dataType: "json",
                headers: {
                    "Authorization": $.cookie("Authorization")
                },
                data: JSON.stringify(item),
                contentType: "application/json;charset=utf-8",
                success: function (json) {
                    if (json["msg"] == "更新数据成功") {
                        $("#success").fadeIn()
                        $("#success-title").html(json["msg"])
                        $("#plan-edit").fadeOut()
                        setTimeout(function () {
                            $("#success").fadeOut()
                            location.href = "?tabId=1"
                        }, 1000)
                    } else {
                        $("#error").fadeIn()
                        $("#error-title").html("更新数据失败")
                        setTimeout(function () {
                            $("#error").fadeOut()
                        }, 1000)
                    }
                }
            })
        } else if (op == "add") {
            var item = {
                "cud": "post",
                "name": $("#plan-input-name-add").val(),
                "description": $("#plan-input-description-add").val()
            }
            $.ajax({
                type: "POST",
                url: "/in/api/tools/v1/plan",
                dataType: "json",
                headers: {
                    "Authorization": $.cookie("Authorization")
                },
                data: JSON.stringify(item),
                contentType: "application/json;charset=utf-8",
                success: function (json) {
                    if (json["msg"] == "新增数据成功") {
                        $("#success").fadeIn()
                        $("#success-title").html(json["msg"])
                        $("#plan-add").fadeOut()
                        setTimeout(function () {
                            $("#success").fadeOut()
                            location.href = "?tabId=1"
                        }, 1000)
                    } else {
                        $("#error").fadeIn()
                        $("#error-title").html("新增数据成功")
                        setTimeout(function () {
                            $("#error").fadeOut()
                        }, 1000)
                    }
                }
            })
        }
    }
</script>
{{ end }}